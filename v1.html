<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestión de Préstamos</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2c3e50;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
        }
        
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .login-container {
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%);
        }
        
        .login-form {
            background-color: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
        }
        
        .sidebar {
            background-color: var(--secondary-color);
            color: white;
            height: 100vh;
            padding: 0;
            position: fixed;
        }
        
        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.8);
            padding: 1rem 1.5rem;
            border-left: 4px solid transparent;
        }
        
        .sidebar .nav-link:hover, .sidebar .nav-link.active {
            color: white;
            background-color: rgba(255, 255, 255, 0.1);
            border-left-color: var(--primary-color);
        }
        
        .main-content {
            margin-left: 250px;
            padding: 20px;
        }
        
        .card-dashboard {
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s;
        }
        
        .card-dashboard:hover {
            transform: translateY(-5px);
        }
        
        .progress {
            height: 10px;
        }
        
        .efficiency-badge {
            font-size: 0.85rem;
            padding: 0.35rem 0.65rem;
            border-radius: 50rem;
        }
        
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }
            
            .main-content {
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Contenedor de Login -->
    <div id="login-container" class="login-container">
        <div class="login-form">
            <h2 class="text-center mb-4">Sistema de Préstamos</h2>
            <form id="login-form">
                <div class="mb-3">
                    <label for="username" class="form-label">Usuario</label>
                    <input type="text" class="form-control" id="username" required>
                </div>
                <div class="mb-3">
                    <label for="password" class="form-label">Contraseña</label>
                    <input type="password" class="form-control" id="password" required>
                </div>
                <button type="submit" class="btn btn-primary w-100">Iniciar Sesión</button>
                <p class="text-center mt-3">
                    ¿No tienes cuenta? <a href="#" id="show-register">Regístrate</a>
                </p>
            </form>
            
            <form id="register-form" class="d-none">
                <h3 class="text-center mb-4">Registro de Cobrador</h3>
                <div class="mb-3">
                    <label for="reg-name" class="form-label">Nombre completo</label>
                    <input type="text" class="form-control" id="reg-name" required>
                </div>
                <div class="mb-3">
                    <label for="reg-username" class="form-label">Usuario</label>
                    <input type="text" class="form-control" id="reg-username" required>
                </div>
                <div class="mb-3">
                    <label for="reg-password" class="form-label">Contraseña</label>
                    <input type="password" class="form-control" id="reg-password" required>
                </div>
                <div class="mb-3">
                    <label for="reg-email" class="form-label">Email</label>
                    <input type="email" class="form-control" id="reg-email" required>
                </div>
                <div class="mb-3">
                    <label for="reg-phone" class="form-label">Teléfono</label>
                    <input type="tel" class="form-control" id="reg-phone">
                </div>
                <button type="submit" class="btn btn-success w-100">Registrarse</button>
                <p class="text-center mt-3">
                    ¿Ya tienes cuenta? <a href="#" id="show-login">Inicia sesión</a>
                </p>
            </form>
        </div>
    </div>
    
    <!-- Panel Principal -->
    <div id="main-panel" class="d-none">
        <div class="sidebar">
            <div class="p-3 text-center border-bottom">
                <h4 class="m-0">Sistema de Préstamos</h4>
                <p class="text-muted mb-0" id="sidebar-username">Usuario</p>
            </div>
            <ul class="nav flex-column mt-3">
                <li class="nav-item">
                    <a class="nav-link active" href="#dashboard" data-section="dashboard">
                        <i class="fas fa-tachometer-alt me-2"></i> Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#clientes" data-section="clientes">
                        <i class="fas fa-users me-2"></i> Clientes
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#creditos" data-section="creditos">
                        <i class="fas fa-hand-holding-usd me-2"></i> Créditos
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#pagos" data-section="pagos">
                        <i class="fas fa-money-bill-wave me-2"></i> Pagos
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#objetivo" data-section="objetivo">
                        <i class="fas fa-bullseye me-2"></i> Objetivo Mensual
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" id="logout-btn">
                        <i class="fas fa-sign-out-alt me-2"></i> Cerrar Sesión
                    </a>
                </li>
            </ul>
        </div>
        
        <div class="main-content">
            <!-- Sección Dashboard -->
            <div id="dashboard-section" class="content-section">
                <h2 class="mb-4">Dashboard</h2>
                <div class="row">
                    <div class="col-md-3 mb-4">
                        <div class="card card-dashboard bg-primary text-white">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <div class="flex-grow-1">
                                        <h5 class="card-title">Clientes</h5>
                                        <h2 class="card-text" id="dashboard-clientes-count">0</h2>
                                    </div>
                                    <div>
                                        <i class="fas fa-users fa-2x opacity-50"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-4">
                        <div class="card card-dashboard bg-success text-white">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <div class="flex-grow-1">
                                        <h5 class="card-title">Créditos Activos</h5>
                                        <h2 class="card-text" id="dashboard-creditos-count">0</h2>
                                    </div>
                                    <div>
                                        <i class="fas fa-hand-holding-usd fa-2x opacity-50"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-4">
                        <div class="card card-dashboard bg-warning text-white">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <div class="flex-grow-1">
                                        <h5 class="card-title">Pagos del Mes</h5>
                                        <h2 class="card-text" id="dashboard-pagos-count">0</h2>
                                    </div>
                                    <div>
                                        <i class="fas fa-money-bill-wave fa-2x opacity-50"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-4">
                        <div class="card card-dashboard bg-info text-white">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <div class="flex-grow-1">
                                        <h5 class="card-title">Eficiencia</h5>
                                        <h2 class="card-text" id="dashboard-efficiency">0%</h2>
                                    </div>
                                    <div>
                                        <i class="fas fa-chart-line fa-2x opacity-50"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-8 mb-4">
                        <div class="card">
                            <div class="card-header bg-white">
                                <h5 class="card-title m-0">Objetivo Mensual</h5>
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Progreso: <span id="objetivo-progress">0%</span></span>
                                    <span><span id="objetivo-actual">0</span> / <span id="objetivo-total">0</span></span>
                                </div>
                                <div class="progress mb-4">
                                    <div id="objetivo-progress-bar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <h5 class="m-0">Comisión Estimada: $<span id="comision-estimada">0</span></h5>
                                    <button class="btn btn-sm btn-outline-primary" data-section="objetivo">Editar Objetivo</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4 mb-4">
                        <div class="card">
                            <div class="card-header bg-white">
                                <h5 class="card-title m-0">Últimos Pagos</h5>
                            </div>
                            <div class="card-body p-0">
                                <ul id="ultimos-pagos-list" class="list-group list-group-flush">
                                    <li class="list-group-item">No hay pagos recientes</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header bg-white">
                                <h5 class="card-title m-0">Próximos Vencimientos</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Cliente</th>
                                                <th>Préstamo</th>
                                                <th>Fecha Vencimiento</th>
                                                <th>Monto a Pagar</th>
                                                <th>Estado</th>
                                            </tr>
                                        </thead>
                                        <tbody id="proximos-vencimientos-table">
                                            <tr>
                                                <td colspan="5" class="text-center">No hay vencimientos próximos</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Sección Clientes -->
            <div id="clientes-section" class="content-section d-none">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>Gestión de Clientes</h2>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#clienteModal">
                        <i class="fas fa-plus me-1"></i> Nuevo Cliente
                    </button>
                </div>
                
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="clientes-table">
                                <thead>
                                    <tr>
                                        <th>Nombre</th>
                                        <th>Teléfono</th>
                                        <th>Email</th>
                                        <th>Dirección</th>
                                        <th>Créditos Activos</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Los clientes se cargarán dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Sección Créditos -->
            <div id="creditos-section" class="content-section d-none">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>Gestión de Créditos</h2>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#creditoModal">
                        <i class="fas fa-plus me-1"></i> Nuevo Crédito
                    </button>
                </div>
                
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="creditos-table">
                                <thead>
                                    <tr>
                                        <th>Cliente</th>
                                        <th>Monto</th>
                                        <th>Fecha</th>
                                        <th>Cuota</th>
                                        <th>Interés</th>
                                        <th>Estado</th>
                                        <th>Saldo Pendiente</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Los créditos se cargarán dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Sección Pagos -->
            <div id="pagos-section" class="content-section d-none">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>Registro de Pagos</h2>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#pagoModal">
                        <i class="fas fa-plus me-1"></i> Registrar Pago
                    </button>
                </div>
                
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="pagos-table">
                                <thead>
                                    <tr>
                                        <th>Cliente</th>
                                        <th>Crédito</th>
                                        <th>Fecha Pago</th>
                                        <th>Monto</th>
                                        <th>Método</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Los pagos se cargarán dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Sección Objetivo Mensual -->
            <div id="objetivo-section" class="content-section d-none">
                <div class="row justify-content-center">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-white">
                                <h3 class="card-title m-0">Objetivo Mensual</h3>
                            </div>
                            <div class="card-body">
                                <form id="objetivo-form">
                                    <div class="mb-3">
                                        <label for="objetivo-mensual" class="form-label">Establecer objetivo de cobranza mensual</label>
                                        <div class="input-group">
                                            <span class="input-group-text">$</span>
                                            <input type="number" class="form-control" id="objetivo-mensual" min="0" step="0.01" required>
                                        </div>
                                        <div class="form-text">Este objetivo se utiliza para calcular tu eficiencia y comisión.</div>
                                    </div>
                                    <button type="submit" class="btn btn-primary">Guardar Objetivo</button>
                                </form>
                                
                                <hr>
                                
                                <div class="mt-4">
                                    <h5>Resumen del Mes Actual</h5>
                                    <div class="d-flex justify-content-between mt-3">
                                        <span>Total Cobrado:</span>
                                        <strong id="total-cobrado-mes">$0.00</strong>
                                    </div>
                                    <div class="d-flex justify-content-between mt-2">
                                        <span>Objetivo:</span>
                                        <strong id="objetivo-actual-mes">$0.00</strong>
                                    </div>
                                    <div class="d-flex justify-content-between mt-2">
                                        <span>Porcentaje de cumplimiento:</span>
                                        <strong id="porcentaje-cumplimiento">0%</strong>
                                    </div>
                                    <div class="progress mt-3">
                                        <div id="progress-bar-cumplimiento" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal para agregar/editar cliente -->
    <div class="modal fade" id="clienteModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="clienteModalTitle">Nuevo Cliente</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="cliente-form">
                        <input type="hidden" id="cliente-id">
                        <div class="mb-3">
                            <label for="cliente-nombre" class="form-label">Nombre completo</label>
                            <input type="text" class="form-control" id="cliente-nombre" required>
                        </div>
                        <div class="mb-3">
                            <label for="cliente-telefono" class="form-label">Teléfono</label>
                            <input type="tel" class="form-control" id="cliente-telefono">
                        </div>
                        <div class="mb-3">
                            <label for="cliente-email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="cliente-email">
                        </div>
                        <div class="mb-3">
                            <label for="cliente-direccion" class="form-label">Dirección</label>
                            <textarea class="form-control" id="cliente-direccion" rows="2"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="save-cliente">Guardar</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal para agregar/editar crédito -->
    <div class="modal fade" id="creditoModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="creditoModalTitle">Nuevo Crédito</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="credito-form">
                        <input type="hidden" id="credito-id">
                        <div class="mb-3">
                            <label for="credito-cliente" class="form-label">Cliente</label>
                            <select class="form-select" id="credito-cliente" required>
                                <option value="">Seleccionar cliente</option>
                                <!-- Las opciones se cargarán dinámicamente -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="credito-monto" class="form-label">Monto del crédito</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="credito-monto" min="0" step="0.01" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="credito-fecha" class="form-label">Fecha de préstamo</label>
                            <input type="date" class="form-control" id="credito-fecha" required>
                        </div>
                        <div class="mb-3">
                            <label for="credito-plazo" class="form-label">Plazo (meses)</label>
                            <input type="number" class="form-control" id="credito-plazo" min="1" required>
                        </div>
                        <div class="mb-3">
                            <label for="credito-interes" class="form-label">Tasa de interés mensual (%)</label>
                            <input type="number" class="form-control" id="credito-interes" min="0" step="0.1" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="save-credito">Guardar</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal para registrar pago -->
    <div class="modal fade" id="pagoModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Registrar Pago</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="pago-form">
                        <input type="hidden" id="pago-id">
                        <div class="mb-3">
                            <label for="pago-credito" class="form-label">Seleccionar Crédito</label>
                            <select class="form-select" id="pago-credito" required>
                                <option value="">Seleccionar crédito</option>
                                <!-- Las opciones se cargarán dinámicamente -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="pago-monto" class="form-label">Monto del pago</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="pago-monto" min="0" step="0.01" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="pago-fecha" class="form-label">Fecha de pago</label>
                            <input type="date" class="form-control" id="pago-fecha" required>
                        </div>
                        <div class="mb-3">
                            <label for="pago-metodo" class="form-label">Método de pago</label>
                            <select class="form-select" id="pago-metodo" required>
                                <option value="Efectivo">Efectivo</option>
                                <option value="Transferencia">Transferencia</option>
                                <option value="Tarjeta">Tarjeta de débito/crédito</option>
                                <option value="Otro">Otro</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="save-pago">Registrar Pago</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS y Popper.js -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
    
    <script>
        // Variables globales
        let currentUser = null;
        let users = JSON.parse(localStorage.getItem('loanUsers')) || [];
        let clients = JSON.parse(localStorage.getItem('loanClients')) || [];
        let credits = JSON.parse(localStorage.getItem('loanCredits')) || [];
        let payments = JSON.parse(localStorage.getItem('loanPayments')) || [];
        
        // Inicialización cuando el DOM está listo
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar si hay una sesión activa
            const loggedInUser = localStorage.getItem('loggedInUser');
            if (loggedInUser) {
                currentUser = JSON.parse(loggedInUser);
                showMainPanel();
            }
            
            // Event listeners para formularios de login/registro
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('register-form').addEventListener('submit', handleRegister);
            document.getElementById('show-register').addEventListener('click', showRegisterForm);
            document.getElementById('show-login').addEventListener('click', showLoginForm);
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            
            // Event listeners para navegación
            document.querySelectorAll('.nav-link[data-section]').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    showSection(this.getAttribute('data-section'));
                });
            });
            
            // Event listeners para formularios de gestión
            document.getElementById('objetivo-form').addEventListener('submit', handleObjetivo);
            document.getElementById('save-cliente').addEventListener('click', saveCliente);
            document.getElementById('save-credito').addEventListener('click', saveCredito);
            document.getElementById('save-pago').addEventListener('click', savePago);
            
            // Inicializar modales de Bootstrap
            const clienteModal = new bootstrap.Modal(document.getElementById('clienteModal'));
            const creditoModal = new bootstrap.Modal(document.getElementById('creditoModal'));
            const pagoModal = new bootstrap.Modal(document.getElementById('pagoModal'));
            
            // Eventos para cuando se cierran los modales
            document.getElementById('clienteModal').addEventListener('hidden.bs.modal', resetClienteForm);
            document.getElementById('creditoModal').addEventListener('hidden.bs.modal', resetCreditoForm);
            document.getElementById('pagoModal').addEventListener('hidden.bs.modal', resetPagoForm);
            
            // Eventos para abrir modales desde botones de edición (se asignarán dinámicamente)
        });
        
        // Función para manejar el inicio de sesión
        function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            const user = users.find(u => u.username === username && u.password === password);
            
            if (user) {
                currentUser = user;
                localStorage.setItem('loggedInUser', JSON.stringify(user));
                showMainPanel();
            } else {
                alert('Usuario o contraseña incorrectos');
            }
        }
        
        // Función para manejar el registro de nuevos usuarios
        function handleRegister(e) {
            e.preventDefault();
            const name = document.getElementById('reg-name').value;
            const username = document.getElementById('reg-username').value;
            const password = document.getElementById('reg-password').value;
            const email = document.getElementById('reg-email').value;
            const phone = document.getElementById('reg-phone').value;
            
            // Verificar si el usuario ya existe
            if (users.some(u => u.username === username)) {
                alert('El nombre de usuario ya está en uso');
                return;
            }
            
            const newUser = {
                id: Date.now().toString(),
                name,
                username,
                password,
                email,
                phone,
                monthlyGoal: 0,
                efficiency: 0,
                commissionRate: 0.05 // Comisión base del 5%
            };
            
            users.push(newUser);
            localStorage.setItem('loanUsers', JSON.stringify(users));
            
            alert('Registro exitoso. Ahora puedes iniciar sesión.');
            showLoginForm();
        }
        
        // Función para mostrar el formulario de registro
        function showRegisterForm(e) {
            if (e) e.preventDefault();
            document.getElementById('login-form').classList.add('d-none');
            document.getElementById('register-form').classList.remove('d-none');
        }
        
        // Función para mostrar el formulario de login
        function showLoginForm(e) {
            if (e) e.preventDefault();
            document.getElementById('register-form').classList.add('d-none');
            document.getElementById('login-form').classList.remove('d-none');
        }
        
        // Función para mostrar el panel principal
        function showMainPanel() {
            document.getElementById('login-container').classList.add('d-none');
            document.getElementById('main-panel').classList.remove('d-none');
            
            // Actualizar la interfaz con los datos del usuario
            document.getElementById('sidebar-username').textContent = currentUser.name;
            
            // Cargar datos y mostrar el dashboard por defecto
            loadUserData();
            showSection('dashboard');
        }
        
        // Función para manejar el cierre de sesión
        function handleLogout(e) {
            e.preventDefault();
            currentUser = null;
            localStorage.removeItem('loggedInUser');
            document.getElementById('main-panel').classList.add('d-none');
            document.getElementById('login-container').classList.remove('d-none');
            
            // Resetear formularios
            document.getElementById('login-form').reset();
            document.getElementById('register-form').reset();
            showLoginForm();
        }
        
        // Función para cambiar entre secciones
        function showSection(sectionId) {
            // Ocultar todas las secciones
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.add('d-none');
            });
            
            // Mostrar la sección seleccionada
            document.getElementById(`${sectionId}-section`).classList.remove('d-none');
            
            // Actualizar navegación activa
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            document.querySelector(`.nav-link[data-section="${sectionId}"]`).classList.add('active');
            
            // Cargar datos específicos de la sección
            switch(sectionId) {
                case 'dashboard':
                    updateDashboard();
                    break;
                case 'clientes':
                    loadClientesTable();
                    break;
                case 'creditos':
                    loadCreditosTable();
                    break;
                case 'pagos':
                    loadPagosTable();
                    break;
                case 'objetivo':
                    loadObjetivoData();
                    break;
            }
        }
        
        // Función para cargar los datos del usuario actual
        function loadUserData() {
            // Filtrar clientes, créditos y pagos del usuario actual
            clients = JSON.parse(localStorage.getItem('loanClients')) || [];
            credits = JSON.parse(localStorage.getItem('loanCredits')) || [];
            payments = JSON.parse(localStorage.getItem('loanPayments')) || [];
            
            // Actualizar el usuario actual con los datos más recientes
            const updatedUser = users.find(u => u.id === currentUser.id);
            if (updatedUser) {
                currentUser = updatedUser;
                localStorage.setItem('loggedInUser', JSON.stringify(currentUser));
            }
        }
        
        // Función para actualizar el dashboard
        function updateDashboard() {
            // Obtener datos actualizados
            loadUserData();
            
            // Calcular estadísticas
            const userClients = clients.filter(c => c.userId === currentUser.id);
            const userCredits = credits.filter(c => c.userId === currentUser.id);
            const userPayments = payments.filter(p => p.userId === currentUser.id);
            
            // Créditos activos (con saldo pendiente > 0)
            const activeCredits = userCredits.filter(c => c.balance > 0);
            
            // Pagos del mes actual
            const currentDate = new Date();
            const currentMonth = currentDate.getMonth();
            const currentYear = currentDate.getFullYear();
            const currentMonthPayments = userPayments.filter(p => {
                const paymentDate = new Date(p.date);
                return paymentDate.getMonth() === currentMonth && 
                       paymentDate.getFullYear() === currentYear;
            });
            
            // Calcular eficiencia
            calculateEfficiency();
            
            // Actualizar UI
            document.getElementById('dashboard-clientes-count').textContent = userClients.length;
            document.getElementById('dashboard-creditos-count').textContent = activeCredits.length;
            document.getElementById('dashboard-pagos-count').textContent = currentMonthPayments.length;
            document.getElementById('dashboard-efficiency').textContent = `${currentUser.efficiency}%`;
            
            // Actualizar objetivo mensual
            const totalCollected = currentMonthPayments.reduce((sum, p) => sum + p.amount, 0);
            const goalProgress = currentUser.monthlyGoal > 0 ? (totalCollected / currentUser.monthlyGoal) * 100 : 0;
            
            document.getElementById('objetivo-progress').textContent = `${goalProgress.toFixed(1)}%`;
            document.getElementById('objetivo-actual').textContent = `$${totalCollected.toFixed(2)}`;
            document.getElementById('objetivo-total').textContent = `$${currentUser.monthlyGoal.toFixed(2)}`;
            
            const progressBar = document.getElementById('objetivo-progress-bar');
            progressBar.style.width = `${goalProgress}%`;
            progressBar.setAttribute('aria-valuenow', goalProgress);
            
            // Asignar clase de color según el progreso
            if (goalProgress >= 100) {
                progressBar.className = 'progress-bar bg-success';
            } else if (goalProgress >= 70) {
                progressBar.className = 'progress-bar bg-warning';
            } else {
                progressBar.className = 'progress-bar bg-danger';
            }
            
            // Calcular comisión estimada
            const commission = totalCollected * currentUser.commissionRate;
            document.getElementById('comision-estimada').textContent = commission.toFixed(2);
            
            // Cargar últimos pagos
            loadUltimosPagos();
            
            // Cargar próximos vencimientos
            loadProximosVencimientos();
        }
        
        // Función para calcular la eficiencia del cobrador
        function calculateEfficiency() {
            const userCredits = credits.filter(c => c.userId === currentUser.id);
            const userPayments = payments.filter(p => p.userId === currentUser.id);
            
            // Calcular el total de créditos asignados
            const totalAssigned = userCredits.reduce((sum, credit) => sum + credit.amount, 0);
            
            // Calcular el total de pagos recibidos
            const totalCollected = userPayments.reduce((sum, payment) => sum + payment.amount, 0);
            
            // Calcular eficiencia (porcentaje de cobrado vs asignado)
            const efficiency = totalAssigned > 0 ? (totalCollected / totalAssigned) * 100 : 0;
            
            // Actualizar eficiencia del usuario
            currentUser.efficiency = efficiency.toFixed(1);
            
            // Ajustar la comisión según la eficiencia
            if (efficiency >= 90) {
                currentUser.commissionRate = 0.08; // 8% de comisión por alta eficiencia
            } else if (efficiency >= 70) {
                currentUser.commissionRate = 0.06; // 6% de comisión por eficiencia media
            } else {
                currentUser.commissionRate = 0.05; // 5% de comisión base
            }
            
            // Actualizar usuario en el almacenamiento
            const userIndex = users.findIndex(u => u.id === currentUser.id);
            if (userIndex !== -1) {
                users[userIndex] = currentUser;
                localStorage.setItem('loanUsers', JSON.stringify(users));
                localStorage.setItem('loggedInUser', JSON.stringify(currentUser));
            }
        }
        
        // Función para cargar los últimos pagos en el dashboard
        function loadUltimosPagos() {
            const userPayments = payments.filter(p => p.userId === currentUser.id);
            const ultimosPagos = userPayments
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 5);
            
            const pagosList = document.getElementById('ultimos-pagos-list');
            pagosList.innerHTML = '';
            
            if (ultimosPagos.length === 0) {
                pagosList.innerHTML = '<li class="list-group-item">No hay pagos recientes</li>';
                return;
            }
            
            ultimosPagos.forEach(pago => {
                const credito = credits.find(c => c.id === pago.creditId);
                const cliente = clients.find(c => c.id === credito.clientId);
                
                const li = document.createElement('li');
                li.className = 'list-group-item';
                li.innerHTML = `
                    <div class="d-flex justify-content-between">
                        <div>
                            <strong>${cliente ? cliente.name : 'Cliente no encontrado'}</strong>
                            <br>
                            <small class="text-muted">${new Date(pago.date).toLocaleDateString()}</small>
                        </div>
                        <div class="text-end">
                            <span class="d-block">$${pago.amount.toFixed(2)}</span>
                            <small class="text-muted">${pago.method}</small>
                        </div>
                    </div>
                `;
                
                pagosList.appendChild(li);
            });
        }
        
        // Función para cargar los próximos vencimientos
        function loadProximosVencimientos() {
            const userCredits = credits.filter(c => c.userId === currentUser.id && c.balance > 0);
            const today = new Date();
            const nextWeek = new Date(today);
            nextWeek.setDate(today.getDate() + 7);
            
            const proximosVencimientos = userCredits.filter(credito => {
                // Calcular la próxima fecha de pago (simulación simple)
                const nextPaymentDate = new Date(credito.nextPaymentDate || credito.date);
                return nextPaymentDate >= today && nextPaymentDate <= nextWeek;
            });
            
            const tableBody = document.getElementById('proximos-vencimientos-table');
            tableBody.innerHTML = '';
            
            if (proximosVencimientos.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center">No hay vencimientos próximos</td></tr>';
                return;
            }
            
            proximosVencimientos.forEach(credito => {
                const cliente = clients.find(c => c.id === credito.clientId);
                const nextPaymentDate = new Date(credito.nextPaymentDate || credito.date);
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${cliente ? cliente.name : 'Cliente no encontrado'}</td>
                    <td>$${credito.amount.toFixed(2)}</td>
                    <td>${nextPaymentDate.toLocaleDateString()}</td>
                    <td>$${credito.installment.toFixed(2)}</td>
                    <td><span class="badge bg-warning">Próximo</span></td>
                `;
                
                tableBody.appendChild(tr);
            });
        }
        
        // Función para cargar la tabla de clientes
        function loadClientesTable() {
            const userClients = clients.filter(c => c.userId === currentUser.id);
            const tableBody = document.getElementById('clientes-table').querySelector('tbody');
            tableBody.innerHTML = '';
            
            if (userClients.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center">No hay clientes registrados</td></tr>';
                return;
            }
            
            userClients.forEach(cliente => {
                // Contar créditos activos del cliente
                const clientCredits = credits.filter(c => c.clientId === cliente.id && c.balance > 0);
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${cliente.name}</td>
                    <td>${cliente.phone || 'N/A'}</td>
                    <td>${cliente.email || 'N/A'}</td>
                    <td>${cliente.address || 'N/A'}</td>
                    <td>${clientCredits.length}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary edit-cliente" data-id="${cliente.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger delete-cliente" data-id="${cliente.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(tr);
            });
            
            // Asignar eventos a los botones de editar y eliminar
            document.querySelectorAll('.edit-cliente').forEach(btn => {
                btn.addEventListener('click', function() {
                    const clientId = this.getAttribute('data-id');
                    editCliente(clientId);
                });
            });
            
            document.querySelectorAll('.delete-cliente').forEach(btn => {
                btn.addEventListener('click', function() {
                    const clientId = this.getAttribute('data-id');
                    deleteCliente(clientId);
                });
            });
        }
        
        // Función para editar un cliente
        function editCliente(clientId) {
            const cliente = clients.find(c => c.id === clientId);
            if (!cliente) return;
            
            document.getElementById('clienteModalTitle').textContent = 'Editar Cliente';
            document.getElementById('cliente-id').value = cliente.id;
            document.getElementById('cliente-nombre').value = cliente.name;
            document.getElementById('cliente-telefono').value = cliente.phone || '';
            document.getElementById('cliente-email').value = cliente.email || '';
            document.getElementById('cliente-direccion').value = cliente.address || '';
            
            const modal = new bootstrap.Modal(document.getElementById('clienteModal'));
            modal.show();
        }
        
        // Función para eliminar un cliente
        function deleteCliente(clientId) {
            if (!confirm('¿Estás seguro de que deseas eliminar este cliente? También se eliminarán sus créditos y pagos asociados.')) {
                return;
            }
            
            // Eliminar cliente
            clients = clients.filter(c => c.id !== clientId);
            
            // Eliminar créditos asociados
            const creditsToDelete = credits.filter(c => c.clientId === clientId);
            credits = credits.filter(c => c.clientId !== clientId);
            
            // Eliminar pagos asociados
            const creditIds = creditsToDelete.map(c => c.id);
            payments = payments.filter(p => !creditIds.includes(p.creditId));
            
            // Guardar cambios
            localStorage.setItem('loanClients', JSON.stringify(clients));
            localStorage.setItem('loanCredits', JSON.stringify(credits));
            localStorage.setItem('loanPayments', JSON.stringify(payments));
            
            // Recargar tabla
            loadClientesTable();
            
            // Actualizar dashboard si está visible
            if (!document.getElementById('dashboard-section').classList.contains('d-none')) {
                updateDashboard();
            }
        }
        
        // Función para guardar un cliente (nuevo o editado)
        function saveCliente() {
            const clientId = document.getElementById('cliente-id').value;
            const name = document.getElementById('cliente-nombre').value;
            const phone = document.getElementById('cliente-telefono').value;
            const email = document.getElementById('cliente-email').value;
            const address = document.getElementById('cliente-direccion').value;
            
            if (!name) {
                alert('El nombre es obligatorio');
                return;
            }
            
            if (clientId) {
                // Editar cliente existente
                const index = clients.findIndex(c => c.id === clientId);
                if (index !== -1) {
                    clients[index] = {
                        ...clients[index],
                        name,
                        phone,
                        email,
                        address
                    };
                }
            } else {
                // Crear nuevo cliente
                const newClient = {
                    id: Date.now().toString(),
                    userId: currentUser.id,
                    name,
                    phone,
                    email,
                    address,
                    createdAt: new Date().toISOString()
                };
                
                clients.push(newClient);
            }
            
            // Guardar en localStorage
            localStorage.setItem('loanClients', JSON.stringify(clients));
            
            // Cerrar modal y recargar tabla
            const modal = bootstrap.Modal.getInstance(document.getElementById('clienteModal'));
            modal.hide();
            
            loadClientesTable();
            
            // Actualizar dashboard si está visible
            if (!document.getElementById('dashboard-section').classList.contains('d-none')) {
                updateDashboard();
            }
        }
        
        // Función para resetear el formulario de cliente
        function resetClienteForm() {
            document.getElementById('clienteModalTitle').textContent = 'Nuevo Cliente';
            document.getElementById('cliente-form').reset();
            document.getElementById('cliente-id').value = '';
        }
        
        // Función para cargar la tabla de créditos
        function loadCreditosTable() {
            const userCredits = credits.filter(c => c.userId === currentUser.id);
            const tableBody = document.getElementById('creditos-table').querySelector('tbody');
            tableBody.innerHTML = '';
            
            if (userCredits.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="8" class="text-center">No hay créditos registrados</td></tr>';
                return;
            }
            
            userCredits.forEach(credito => {
                const cliente = clients.find(c => c.id === credito.clientId);
                
                // Determinar el estado del crédito
                let statusBadge;
                if (credito.balance <= 0) {
                    statusBadge = '<span class="badge bg-success">Pagado</span>';
                } else if (credito.balance < credito.amount) {
                    statusBadge = '<span class="badge bg-warning">En progreso</span>';
                } else {
                    statusBadge = '<span class="badge bg-danger">Pendiente</span>';
                }
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${cliente ? cliente.name : 'Cliente no encontrado'}</td>
                    <td>$${credito.amount.toFixed(2)}</td>
                    <td>${new Date(credito.date).toLocaleDateString()}</td>
                    <td>$${credito.installment.toFixed(2)}</td>
                    <td>${credito.interestRate}%</td>
                    <td>${statusBadge}</td>
                    <td>$${credito.balance.toFixed(2)}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary edit-credito" data-id="${credito.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger delete-credito" data-id="${credito.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(tr);
            });
            
            // Asignar eventos a los botones de editar y eliminar
            document.querySelectorAll('.edit-credito').forEach(btn => {
                btn.addEventListener('click', function() {
                    const creditId = this.getAttribute('data-id');
                    editCredito(creditId);
                });
            });
            
            document.querySelectorAll('.delete-credito').forEach(btn => {
                btn.addEventListener('click', function() {
                    const creditId = this.getAttribute('data-id');
                    deleteCredito(creditId);
                });
            });
            
            // Cargar opciones de clientes en el modal de crédito
            loadClientOptions();
        }
        
        // Función para cargar las opciones de clientes en el select
        function loadClientOptions() {
            const userClients = clients.filter(c => c.userId === currentUser.id);
            const select = document.getElementById('credito-cliente');
            
            // Guardar la selección actual
            const currentSelection = select.value;
            
            // Limpiar opciones excepto la primera
            while (select.options.length > 1) {
                select.remove(1);
            }
            
            // Agregar opciones de clientes
            userClients.forEach(cliente => {
                const option = document.createElement('option');
                option.value = cliente.id;
                option.textContent = cliente.name;
                select.appendChild(option);
            });
            
            // Restaurar selección si existe
            if (currentSelection) {
                select.value = currentSelection;
            }
        }
        
        // Función para editar un crédito
        function editCredito(creditId) {
            const credito = credits.find(c => c.id === creditId);
            if (!credito) return;
            
            document.getElementById('creditoModalTitle').textContent = 'Editar Crédito';
            document.getElementById('credito-id').value = credito.id;
            document.getElementById('credito-cliente').value = credito.clientId;
            document.getElementById('credito-monto').value = credito.amount;
            document.getElementById('credito-fecha').value = credito.date.split('T')[0];
            document.getElementById('credito-plazo').value = credito.term;
            document.getElementById('credito-interes').value = credito.interestRate;
            
            const modal = new bootstrap.Modal(document.getElementById('creditoModal'));
            modal.show();
        }
        
        // Función para eliminar un crédito
        function deleteCredito(creditId) {
            if (!confirm('¿Estás seguro de que deseas eliminar este crédito? También se eliminarán los pagos asociados.')) {
                return;
            }
            
            // Eliminar crédito
            credits = credits.filter(c => c.id !== creditId);
            
            // Eliminar pagos asociados
            payments = payments.filter(p => p.creditId !== creditId);
            
            // Guardar cambios
            localStorage.setItem('loanCredits', JSON.stringify(credits));
            localStorage.setItem('loanPayments', JSON.stringify(payments));
            
            // Recargar tabla
            loadCreditosTable();
            
            // Actualizar dashboard si está visible
            if (!document.getElementById('dashboard-section').classList.contains('d-none')) {
                updateDashboard();
            }
        }
        
        // Función para guardar un crédito (nuevo o editado)
        function saveCredito() {
            const creditId = document.getElementById('credito-id').value;
            const clientId = document.getElementById('credito-cliente').value;
            const amount = parseFloat(document.getElementById('credito-monto').value);
            const date = document.getElementById('credito-fecha').value;
            const term = parseInt(document.getElementById('credito-plazo').value);
            const interestRate = parseFloat(document.getElementById('credito-interes').value);
            
            if (!clientId || !amount || !date || !term || !interestRate) {
                alert('Todos los campos son obligatorios');
                return;
            }
            
            // Calcular la cuota mensual (fórmula simplificada)
            const monthlyInterest = interestRate / 100;
            const installment = (amount * monthlyInterest) / (1 - Math.pow(1 + monthlyInterest, -term));
            
            if (creditId) {
                // Editar crédito existente
                const index = credits.findIndex(c => c.id === creditId);
                if (index !== -1) {
                    credits[index] = {
                        ...credits[index],
                        clientId,
                        amount,
                        date,
                        term,
                        interestRate,
                        installment,
                        // Mantener el balance actual al editar
                        balance: credits[index].balance
                    };
                }
            } else {
                // Crear nuevo crédito
                const newCredit = {
                    id: Date.now().toString(),
                    userId: currentUser.id,
                    clientId,
                    amount,
                    date,
                    term,
                    interestRate,
                    installment,
                    balance: amount, // Saldo inicial igual al monto del crédito
                    createdAt: new Date().toISOString()
                };
                
                credits.push(newCredit);
            }
            
            // Guardar en localStorage
            localStorage.setItem('loanCredits', JSON.stringify(credits));
            
            // Cerrar modal y recargar tabla
            const modal = bootstrap.Modal.getInstance(document.getElementById('creditoModal'));
            modal.hide();
            
            loadCreditosTable();
            
            // Actualizar dashboard si está visible
            if (!document.getElementById('dashboard-section').classList.contains('d-none')) {
                updateDashboard();
            }
        }
        
        // Función para resetear el formulario de crédito
        function resetCreditoForm() {
            document.getElementById('creditoModalTitle').textContent = 'Nuevo Crédito';
            document.getElementById('credito-form').reset();
            document.getElementById('credito-id').value = '';
        }
        
        // Función para cargar la tabla de pagos
        function loadPagosTable() {
            const userPayments = payments.filter(p => p.userId === currentUser.id);
            const tableBody = document.getElementById('pagos-table').querySelector('tbody');
            tableBody.innerHTML = '';
            
            if (userPayments.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center">No hay pagos registrados</td></tr>';
                return;
            }
            
            userPayments.forEach(pago => {
                const credito = credits.find(c => c.id === pago.creditId);
                const cliente = credito ? clients.find(c => c.id === credito.clientId) : null;
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${cliente ? cliente.name : 'Cliente no encontrado'}</td>
                    <td>$${credito ? credito.amount.toFixed(2) : 'N/A'}</td>
                    <td>${new Date(pago.date).toLocaleDateString()}</td>
                    <td>$${pago.amount.toFixed(2)}</td>
                    <td>${pago.method}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-danger delete-pago" data-id="${pago.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(tr);
            });
            
            // Asignar eventos a los botones de eliminar
            document.querySelectorAll('.delete-pago').forEach(btn => {
                btn.addEventListener('click', function() {
                    const paymentId = this.getAttribute('data-id');
                    deletePago(paymentId);
                });
            });
            
            // Cargar opciones de créditos en el modal de pago
            loadCreditOptions();
        }
        
        // Función para cargar las opciones de créditos en el select
        function loadCreditOptions() {
            const userCredits = credits.filter(c => c.userId === currentUser.id && c.balance > 0);
            const select = document.getElementById('pago-credito');
            
            // Guardar la selección actual
            const currentSelection = select.value;
            
            // Limpiar opciones excepto la primera
            while (select.options.length > 1) {
                select.remove(1);
            }
            
            // Agregar opciones de créditos
            userCredits.forEach(credito => {
                const cliente = clients.find(c => c.id === credito.clientId);
                const option = document.createElement('option');
                option.value = credito.id;
                option.textContent = `${cliente ? cliente.name : 'Cliente'} - $${credito.balance.toFixed(2)} pendiente`;
                select.appendChild(option);
            });
            
            // Restaurar selección si existe
            if (currentSelection) {
                select.value = currentSelection;
            }
        }
        
        // Función para eliminar un pago
        function deletePago(paymentId) {
            if (!confirm('¿Estás seguro de que deseas eliminar este pago?')) {
                return;
            }
            
            const pago = payments.find(p => p.id === paymentId);
            if (!pago) return;
            
            // Encontrar el crédito asociado
            const credito = credits.find(c => c.id === pago.creditId);
            if (credito) {
                // Restaurar el balance del crédito
                credito.balance += pago.amount;
                
                // Actualizar el crédito en el almacenamiento
                const creditIndex = credits.findIndex(c => c.id === credito.id);
                if (creditIndex !== -1) {
                    credits[creditIndex] = credito;
                }
            }
            
            // Eliminar pago
            payments = payments.filter(p => p.id !== paymentId);
            
            // Guardar cambios
            localStorage.setItem('loanCredits', JSON.stringify(credits));
            localStorage.setItem('loanPayments', JSON.stringify(payments));
            
            // Recargar tabla
            loadPagosTable();
            
            // Actualizar dashboard si está visible
            if (!document.getElementById('dashboard-section').classList.contains('d-none')) {
                updateDashboard();
            }
        }
        
        // Función para guardar un pago
        function savePago() {
            const creditId = document.getElementById('pago-credito').value;
            const amount = parseFloat(document.getElementById('pago-monto').value);
            const date = document.getElementById('pago-fecha').value;
            const method = document.getElementById('pago-metodo').value;
            
            if (!creditId || !amount || !date || !method) {
                alert('Todos los campos son obligatorios');
                return;
            }
            
            // Verificar que el crédito existe
            const credito = credits.find(c => c.id === creditId);
            if (!credito) {
                alert('El crédito seleccionado no existe');
                return;
            }
            
            // Verificar que el monto no excede el saldo pendiente
            if (amount > credito.balance) {
                alert('El monto del pago no puede exceder el saldo pendiente del crédito');
                return;
            }
            
            // Crear nuevo pago
            const newPayment = {
                id: Date.now().toString(),
                userId: currentUser.id,
                creditId,
                amount,
                date,
                method,
                createdAt: new Date().toISOString()
            };
            
            payments.push(newPayment);
            
            // Actualizar el balance del crédito
            credito.balance -= amount;
            
            // Si el crédito está completamente pagado, actualizar estado
            if (credito.balance <= 0) {
                credito.balance = 0;
                // Aquí podrías agregar lógica adicional para créditos pagados
            }
            
            // Actualizar el crédito en el array
            const creditIndex = credits.findIndex(c => c.id === creditId);
            if (creditIndex !== -1) {
                credits[creditIndex] = credito;
            }
            
            // Guardar en localStorage
            localStorage.setItem('loanPayments', JSON.stringify(payments));
            localStorage.setItem('loanCredits', JSON.stringify(credits));
            
            // Cerrar modal y recargar tabla
            const modal = bootstrap.Modal.getInstance(document.getElementById('pagoModal'));
            modal.hide();
            
            loadPagosTable();
            
            // Actualizar dashboard si está visible
            if (!document.getElementById('dashboard-section').classList.contains('d-none')) {
                updateDashboard();
            }
        }
        
        // Función para resetear el formulario de pago
        function resetPagoForm() {
            document.getElementById('pago-form').reset();
            document.getElementById('pago-id').value = '';
        }
        
        // Función para cargar datos de la sección de objetivo mensual
        function loadObjetivoData() {
            document.getElementById('objetivo-mensual').value = currentUser.monthlyGoal || 0;
            
            // Calcular total cobrado en el mes actual
            const currentDate = new Date();
            const currentMonth = currentDate.getMonth();
            const currentYear = currentDate.getFullYear();
            
            const userPayments = payments.filter(p => p.userId === currentUser.id);
            const currentMonthPayments = userPayments.filter(p => {
                const paymentDate = new Date(p.date);
                return paymentDate.getMonth() === currentMonth && 
                       paymentDate.getFullYear() === currentYear;
            });
            
            const totalCollected = currentMonthPayments.reduce((sum, p) => sum + p.amount, 0);
            const monthlyGoal = currentUser.monthlyGoal || 0;
            const percentage = monthlyGoal > 0 ? (totalCollected / monthlyGoal) * 100 : 0;
            
            // Actualizar UI
            document.getElementById('total-cobrado-mes').textContent = `$${totalCollected.toFixed(2)}`;
            document.getElementById('objetivo-actual-mes').textContent = `$${monthlyGoal.toFixed(2)}`;
            document.getElementById('porcentaje-cumplimiento').textContent = `${percentage.toFixed(1)}%`;
            
            const progressBar = document.getElementById('progress-bar-cumplimiento');
            progressBar.style.width = `${percentage}%`;
            progressBar.setAttribute('aria-valuenow', percentage);
            
            // Asignar clase de color según el porcentaje
            if (percentage >= 100) {
                progressBar.className = 'progress-bar bg-success';
            } else if (percentage >= 70) {
                progressBar.className = 'progress-bar bg-warning';
            } else {
                progressBar.className = 'progress-bar bg-danger';
            }
        }
        
        // Función para manejar el establecimiento del objetivo mensual
        function handleObjetivo(e) {
            e.preventDefault();
            const monthlyGoal = parseFloat(document.getElementById('objetivo-mensual').value);
            
            if (isNaN(monthlyGoal) || monthlyGoal < 0) {
                alert('Por favor ingresa un objetivo válido');
                return;
            }
            
            // Actualizar objetivo del usuario
            currentUser.monthlyGoal = monthlyGoal;
            
            // Actualizar usuario en el almacenamiento
            const userIndex = users.findIndex(u => u.id === currentUser.id);
            if (userIndex !== -1) {
                users[userIndex] = currentUser;
                localStorage.setItem('loanUsers', JSON.stringify(users));
                localStorage.setItem('loggedInUser', JSON.stringify(currentUser));
            }
            
            alert('Objetivo mensual actualizado correctamente');
            
            // Actualizar datos mostrados
            loadObjetivoData();
            
            // Actualizar dashboard si está visible
            if (!document.getElementById('dashboard-section').classList.contains('d-none')) {
                updateDashboard();
            }
        }
    </script>
</body>
</html>